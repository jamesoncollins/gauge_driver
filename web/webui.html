<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gauge BLE Web UI</title>
  <style>
    :root{
      --bg:#0b0e14;        /* base */
      --bg-2:#111620;      /* raised */
      --bg-3:#0f1420;      /* sunken */
      --fg:#e6edf3;        /* text */
      --muted:#a0a8b0;     /* secondary text */
      --acc:#4ea1ff;       /* accent */
      --acc-2:#7ee787;     /* ok */
      --warn:#ffb86b;      /* warn */
      --err:#ff6b6b;       /* error */
      --line:#1f2633;      /* borders */
      --pill:#182235;      /* chips */
      --radius:14px;
      --pad:14px;
      --shadow:0 1px 0 rgba(255,255,255,.02) inset, 0 8px 24px rgba(0,0,0,.35);
      --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      --sans: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:var(--sans);line-height:1.35}
    header{position:sticky;top:0;background:linear-gradient(180deg,rgba(11,14,20,.95),rgba(11,14,20,.80));backdrop-filter:saturate(160%) blur(6px);z-index:10;border-bottom:1px solid var(--line)}
    .bar{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 16px}
    .title{font-weight:700;letter-spacing:.2px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-flex;align-items:center;gap:6px;background:var(--pill);border:1px solid var(--line);padding:4px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
    main{padding:18px;max-width:1100px;margin:0 auto}
    .card{background:var(--bg-2);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:10px}
    label{display:block;font-size:12px;color:var(--muted);margin:4px 0}
    input[type="text"], textarea{width:100%;padding:10px;border:1px solid var(--line);background:var(--bg-3);color:var(--fg);border-radius:10px}
    button{padding:9px 12px;border-radius:12px;border:1px solid var(--line);background:var(--bg-3);color:var(--fg);cursor:pointer;transition:.15s ease;box-shadow:0 0 0 rgba(0,0,0,0)}
    button:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(0,0,0,.35)}
    button.primary{background:var(--acc);border-color:transparent;color:#041224}
    button.ghost{background:transparent}
    button:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}
    table{border-collapse:collapse;width:100%}
    td,th{border-bottom:1px solid var(--line);padding:8px;text-align:left;font-size:13px}
    th{color:var(--muted);font-weight:600;background:rgba(255,255,255,.02)}
    .mono{font-family:var(--mono)}

    /* Accordion (roll-up sections) */
    details.section{margin:14px 0;border-radius:var(--radius);overflow:hidden}
    details.section>summary{list-style:none;cursor:pointer;display:flex;align-items:center;gap:10px;padding:12px 14px;background:var(--bg-2);border:1px solid var(--line);border-radius:var(--radius);user-select:none}
    details.section>summary:hover{background:#121a29}
    details.section[open]>summary{border-bottom-left-radius:0;border-bottom-right-radius:0}
    .summary-title{font-weight:600}
    .chev{transition:transform .18s ease;color:var(--muted)}
    details[open] .chev{transform:rotate(90deg)}
    .panel{padding:14px;border:1px solid var(--line);border-top:none;background:var(--bg-3)}

    /* Status console */
    #status{max-height:200px;overflow:auto;padding:12px;margin:0;background:#0a0f19;border-top:1px solid var(--line)}

    footer{color:var(--muted);font-size:12px;text-align:center;margin:18px 0}
    .spacer{flex:1}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="row">
        <div class="title">Gauge BLE Web UI</div>
        <span id="connState" class="pill">● Disconnected</span>
      </div>
      <div class="row">
        <button id="btnConnect" class="primary">Connect</button>
        <button id="btnDisconnect" class="ghost" disabled>Disconnect</button>
      </div>
    </div>
  </header>

  <main>
    <details class="section" open>
      <summary><span class="chev">▶</span><span class="summary-title">Dashboard</span><span class="spacer"></span><span class="pill">Live</span></summary>
      <div class="panel">
        <div class="grid">
          <div class="card" style="padding:14px">
            <div style="font-size:12px;color:var(--muted);margin-bottom:6px">RPM</div>
            <div id="tileRpm" style="font-size:36px;font-weight:800">—</div>
          </div>
          <div class="card" style="padding:14px">
            <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Speed</div>
            <div id="tileSpeed" style="font-size:36px;font-weight:800">—</div>
          </div>
          <div class="card" style="padding:14px">
            <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Loop (ms)</div>
            <div id="tileLoop" style="font-size:24px;font-weight:700">—</div>
            <div id="tileWorst" style="font-size:12px;color:var(--muted)">Worst: —</div>
          </div>
        </div>
      </div>
    </details>
    <details class="section" open>
      <summary><span class="chev">▶</span><span class="summary-title">Connection & UUIDs</span><span class="spacer"></span><span class="pill">Setup</span></summary>
      <div class="panel">
        <div class="grid">
          <div>
            <label>Device filter (name prefix)</label>
            <input id="namePrefix" type="text" placeholder="Gauge" />
          </div>
          <div>
            <label>Custom Service UUID</label>
            <input id="svcUuid" type="text" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" />
          </div>
          <div>
            <label>Commands Char UUID (write)</label>
            <input id="cmdUuid" type="text" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" />
          </div>
          <div>
            <label>BTBuffer Char UUID (notify)</label>
            <input id="bufUuid" type="text" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" />
          </div>
          <div>
            <label>OTA Control Char UUID (write)</label>
            <input id="otaUuid" type="text" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" />
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="btnSaveCfg">Save</button>
          <button id="btnLoadCfg" class="ghost">Load</button>
          <button id="btnClearCfg" class="ghost">Clear</button>
        </div>
      </div>
    </details>

    <details class="section" open>
      <summary><span class="chev">▶</span><span class="summary-title">Commands</span><span class="spacer"></span><span class="pill">Write</span></summary>
      <div class="panel">
        <div class="row" style="margin-bottom:10px">
          <button data-cmd="LEFT">◀ Left</button>
          <button data-cmd="RIGHT">▶ Right</button>
          <button data-cmd="UP">▲ Up</button>
          <button data-cmd="DOWN">▼ Down</button>
          <button data-cmd="ENTER">⏎ Enter</button>
          <button data-cmd="BACK">↩ Back</button>
        </div>
        <div class="row">
          <input id="rawHex" type="text" placeholder="raw hex, e.g. A5 01 02 03"/>
          <button id="btnSendRaw">Send Raw</button>
        </div>
      </div>
    </details>

    <details class="section" open>
      <summary><span class="chev">▶</span><span class="summary-title">ECU Stream (BTBuffer)</span><span class="spacer"></span><span class="pill">Notify</span></summary>
      <div class="panel">
        <div class="row" style="margin-bottom:10px">
          <button id="btnStartLog">Start Log</button>
          <button id="btnStopLog" disabled>Stop Log</button>
          <button id="btnDownload" disabled>Download CSV</button>
        </div>
        <div class="card">
          <table>
            <thead><tr><th style="width:180px">Time</th><th>Payload (hex)</th><th>Parsed</th></tr></thead>
            <tbody id="tblBody"></tbody>
          </table>
        </div>
      </div>
    </details>

    <details class="section">
      <summary><span class="chev">▶</span><span class="summary-title">OTA</span><span class="spacer"></span><span class="pill">Reboot</span></summary>
      <div class="panel">
        <button id="btnOta" style="border-color:var(--warn)">Reboot to OTA</button>
      </div>
    </details>

    <details class="section" open>
      <summary><span class="chev">▶</span><span class="summary-title">Status</span><span class="spacer"></span><span class="pill">Debug</span></summary>
      <div class="panel">
        <pre id="status" class="mono"></pre>
      </div>
    </details>

    <footer>Tip: this UI works best on HTTPS or <span class="mono">localhost</span>.</footer>
  </main>

<script>
(function(){
  // —— Defaults (fill with your UUIDs later) ——
  const Defaults = {
    namePrefix: '3000GT',
    SERVICE_UUID: '',
    CMD_CHAR_UUID: '',   // write w/o response preferred
    BTBUF_CHAR_UUID: '', // notify
    OTA_CHAR_UUID: ''    // write to trigger reboot to OTA FW
  };

  const CommandMap = {
    LEFT:[3], RIGHT:[4], UP:[1], DOWN:[2], ENTER:[0], BACK:[255]
  };

  const OTA_MAGIC = [0xA5];

  // Frame settings
  const USE_LENGTH_PREFIX = true;
  const LENGTH_BYTES = 2; // uint16 LE
  const DELIM = 0x0A; // for delimited mode if enabled

  // —— Helpers ——
  const $ = s => document.querySelector(s);
  function log(msg){ const el=$('#status'); el.textContent += msg+'
'; el.scrollTop=el.scrollHeight; }
  function setState(txt, ok){ $('#connState').textContent = (ok?'● ':'● ')+txt; }
  function hex(u8){ return [...u8].map(b=>b.toString(16).padStart(2,'0')).join(' '); }
  function toBytes(hexStr){ const bytes=[]; hexStr.replace(/[^0-9a-fA-F]/g,'').replace(/(..)/g,(m,b)=>bytes.push(parseInt(b,16))); return new Uint8Array(bytes); }
  function le16(b0,b1){ return b0 | (b1<<8); }

  // Persist inputs
  const KEYS = ['namePrefix','svcUuid','cmdUuid','bufUuid','otaUuid'];
  function saveCfg(){ const cfg={}; for(const k of KEYS){ cfg[k]=$('#'+k).value; } localStorage.setItem('gauge-ble-ui', JSON.stringify(cfg)); log('Config saved'); }
  function loadCfg(){ const s=localStorage.getItem('gauge-ble-ui'); if(!s) return; const cfg=JSON.parse(s); for(const k of KEYS){ if(cfg[k]!==undefined) $('#'+k).value=cfg[k]; } log('Config loaded'); }
  function clearCfg(){ localStorage.removeItem('gauge-ble-ui'); log('Config cleared'); }

  // Restore defaults first-run
  function applyDefaults(){
    if(!localStorage.getItem('gauge-ble-ui')){
      $('#namePrefix').value = Defaults.namePrefix;
      $('#svcUuid').value = Defaults.SERVICE_UUID;
      $('#cmdUuid').value = Defaults.CMD_CHAR_UUID;
      $('#bufUuid').value = Defaults.BTBUF_CHAR_UUID;
      $('#otaUuid').value = Defaults.OTA_CHAR_UUID;
    } else { loadCfg(); }
  }

  class Reassembler {
    constructor(){ this.buf = new Uint8Array(0); }
    push(chunk){
      const combined = new Uint8Array(this.buf.length + chunk.length);
      combined.set(this.buf,0); combined.set(chunk,this.buf.length);
      this.buf = combined;
      const frames=[];
      if(USE_LENGTH_PREFIX){
        while(this.buf.length >= LENGTH_BYTES){
          const len = le16(this.buf[0], this.buf[1]);
          if(this.buf.length < LENGTH_BYTES + len) break;
          const payload = this.buf.slice(LENGTH_BYTES, LENGTH_BYTES+len);
          frames.push(payload);
          this.buf = this.buf.slice(LENGTH_BYTES+len);
        }
      } else {
        let idx; while((idx=this.buf.indexOf(DELIM))!==-1){ frames.push(this.buf.slice(0,idx)); this.buf = this.buf.slice(idx+1); }
      }
      return frames;
    }
    reset(){ this.buf = new Uint8Array(0); }
  }

  function exampleDecode(payload){
    // Parse BTBuffer frame as sent by firmware via READNEXT:
    // struct { u16 id1; u16 id2; u32 tick; u8 data[dataLen]; }
    const dv = new DataView(payload.buffer, payload.byteOffset, payload.byteLength);
    if(payload.byteLength < 8) return {len: payload.length};
    const id1 = dv.getUint16(0,true);
    let id2 = dv.getUint16(2,true);
    // Treat 0xFFFF as -1 to match firmware use
    if(id2 === 0xFFFF) id2 = -1;
    const tick = dv.getUint32(4,true);
    const dataStart = 8;
    const words = [];
    for(let off=dataStart; off+4<=payload.byteLength; off+=4){ words.push(dv.getUint32(off,true)); }
    const parsed = { id1, id2, tick, wordsCount: words.length };

    // Known packet: id1=0,id2=0 contains loopCnt, loopPeriod, worstLoop, _, speed, rpm (u32 each)
    if(id1===0 && id2===0 && words.length>=6){
      parsed.loopCnt = words[0];
      parsed.loopPeriod_ms = words[1];
      parsed.worstLoop_ms = words[2];
      parsed.speed = words[4];
      parsed.rpm = words[5];
    }

    // ECUK status: id1=1,id2=-1 uses words[0] = ECU_REQUEST_DELAY_US constant
    if(id1===1 && id2===-1 && words.length>=1){
      parsed.ecu_req = words[0];
    }

    // Update live tiles when values present
    if(typeof parsed.rpm === 'number'){
      const el = document.getElementById('tileRpm'); if(el) el.textContent = String(parsed.rpm);
    }
    if(typeof parsed.speed === 'number'){
      const el = document.getElementById('tileSpeed'); if(el) el.textContent = String(parsed.speed);
    }
    if(typeof parsed.loopPeriod_ms === 'number'){
      const el = document.getElementById('tileLoop'); if(el) el.textContent = String(parsed.loopPeriod_ms);
      const ew = document.getElementById('tileWorst'); if(ew && typeof parsed.worstLoop_ms==='number') ew.textContent = 'Worst: '+parsed.worstLoop_ms;
    }

    return parsed;
  };
  }

  const state = { device:null, server:null, svc:null, chars:{cmd:null,buf:null,ota:null}, reasm:new Reassembler(), logging:false, logRows:[] };

  async function connect(){
    $('#status').textContent='';
    setState('Requesting...');
    const namePrefix = $('#namePrefix').value || Defaults.namePrefix;
    const options = { filters: namePrefix ? [{namePrefix}] : undefined, optionalServices: [] };
    const svcUuid = $('#svcUuid').value || Defaults.SERVICE_UUID;
    if(svcUuid) options.optionalServices.push(svcUuid);

    try{
      const device = await navigator.bluetooth.requestDevice(options);
      state.device = device; device.addEventListener('gattserverdisconnected', onDisconnect);
      setState('Connecting...');
      state.server = await device.gatt.connect();
      log(`Connected to ${device.name || '(unnamed)'}`);
      setState('Discovering...');

      if(!svcUuid) throw new Error('Missing Service UUID');
      state.svc = await state.server.getPrimaryService(svcUuid);

      const cmdUuid = $('#cmdUuid').value || Defaults.CMD_CHAR_UUID;
      const bufUuid = $('#bufUuid').value || Defaults.BTBUF_CHAR_UUID;
      const otaUuid = $('#otaUuid').value || Defaults.OTA_CHAR_UUID;

      if(cmdUuid) state.chars.cmd = await state.svc.getCharacteristic(cmdUuid);
      if(bufUuid){
        state.chars.buf = await state.svc.getCharacteristic(bufUuid);
        await state.chars.buf.startNotifications();
        state.chars.buf.addEventListener('characteristicvaluechanged', onNotify);
      }
      if(otaUuid) state.chars.ota = await state.svc.getCharacteristic(otaUuid);

      $('#btnDisconnect').disabled=false; $('#btnConnect').disabled=true; setState('Connected', true);
    }catch(err){ log('Connect error: '+err.message); setState('Disconnected'); }
  }

  async function disconnect(){ try{ if(state.device?.gatt?.connected) state.device.gatt.disconnect(); }catch(e){} }
  function onDisconnect(){ log('Disconnected'); $('#btnDisconnect').disabled=true; $('#btnConnect').disabled=false; setState('Disconnected'); }

  function onNotify(ev){
    const dv = ev.target.value; const chunk = new Uint8Array(dv.buffer, dv.byteOffset, dv.byteLength);
    const frames = state.reasm.push(chunk);
    for(const payload of frames){
      const t = new Date().toISOString();
      const parsed = exampleDecode(payload);
      appendRow(t, payload, parsed);
      if(state.logging){ state.logRows.push([t, hex(payload), JSON.stringify(parsed)]); }
    }
  }

  function appendRow(t,u8,parsed){
    const tr=document.createElement('tr');
    tr.innerHTML = `<td class="mono">${t}</td><td class="mono">${hex(u8)}</td><td class="mono">${escapeHtml(JSON.stringify(parsed))}</td>`;
    const tbody=$('#tblBody'); tbody.prepend(tr); while(tbody.rows.length>300) tbody.deleteRow(-1);
  }

  function escapeHtml(s){ return s.replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }

  async function sendCommand(kind){
    if(!state.chars.cmd) return log('No command characteristic');
    const bytes = CommandMap[kind]; if(!bytes) return log('Unknown command '+kind);
    try{ await state.chars.cmd.writeValueWithoutResponse(new Uint8Array(bytes)); log('Sent '+kind+': '+bytes.map(b=>b.toString(16).padStart(2,'0')).join(' ')); }
    catch(err){ log('Send error: '+err.message); }
  }

  async function sendRaw(){
    if(!state.chars.cmd) return log('No command characteristic');
    const text=$('#rawHex').value.trim(); if(!text) return;
    try{
      const buf=toBytes(text); const CHUNK=20;
      for(let i=0;i<buf.length;i+=CHUNK){ await state.chars.cmd.writeValueWithoutResponse(buf.slice(i,Math.min(i+CHUNK,buf.length))); }
      log('Sent RAW: '+text);
    }catch(err){ log('Raw send error: '+err.message); }
  }

  async function doOta(){ if(!state.chars.ota) return log('No OTA characteristic'); if(!confirm('Reboot device into OTA firmware?')) return; try{ await state.chars.ota.writeValueWithoutResponse(new Uint8Array(OTA_MAGIC)); log('OTA reboot requested'); }catch(err){ log('OTA write error: '+err.message); } }

  function startLog(){ state.logging=true; state.logRows=[]; $('#btnDownload').disabled=true; $('#btnStartLog').disabled=true; $('#btnStopLog').disabled=false; }
  function stopLog(){ state.logging=false; $('#btnStopLog').disabled=true; $('#btnStartLog').disabled=false; if(state.logRows.length) $('#btnDownload').disabled=false; }
  function download(){ const rows=[["time","payload_hex","parsed_json"],...state.logRows]; const csv=rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('
'); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='ecu_log_'+Date.now()+'.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1e3); }

  // One-open-at-a-time accordion
  document.querySelectorAll('details.section').forEach((d)=>{
    d.addEventListener('toggle',()=>{ if(d.open){ document.querySelectorAll('details.section').forEach(x=>{ if(x!==d) x.open=false; }); }});
  });

  // UI wiring
  $('#btnConnect').addEventListener('click', connect);
  $('#btnDisconnect').addEventListener('click', disconnect);
  document.querySelectorAll('[data-cmd]').forEach(btn=> btn.addEventListener('click', ()=>sendCommand(btn.dataset.cmd)));
  $('#btnSendRaw').addEventListener('click', sendRaw);
  $('#btnOta').addEventListener('click', doOta);
  $('#btnStartLog').addEventListener('click', startLog);
  $('#btnStopLog').addEventListener('click', stopLog);
  $('#btnDownload').addEventListener('click', download);
  $('#btnSaveCfg').addEventListener('click', saveCfg);
  $('#btnLoadCfg').addEventListener('click', loadCfg);
  $('#btnClearCfg').addEventListener('click', clearCfg);

  applyDefaults();
})();
</script>
</body>
</html>
